---
# tasks file for kvm_host with Ubuntu 16.04

- name: Install KVM-related packages
  apt:
    name: '{{ item }}'
    state: 'latest'
    update_cache: 'yes'
  with_items:
    - 'libvirt-bin'
    - 'netcat-openbsd'
    - 'gawk'
    - 'qemu-system'
    - 'pm-utils'
    - 'ebtables'
    - 'qemu-kvm'
    - 'virtinst'
    - 'bridge-utils'
    - 'cpu-checker'
    - 'openvswitch-switch'
    - 'vlan'
    - 'ifenslave'
    - 'python-lxml'
  # when: ansible_distribution == 'Ubuntu' and ansible_distribution_version == '16.04'


- name: Enable Kernel Modules - Bonding (1/2)
  lineinfile:
    dest: /etc/modules
    line: 'bonding'
  when: kvm_host_ConfigBondInterface


- name: Enable Kernel Modules - Bonding (2/2)
  modprobe:
    name: 'bonding'
    state: present
  when: kvm_host_ConfigBondInterface


- name: Enable Kernel Modules - VLAN (1/2)
  lineinfile:
    dest: /etc/modules
    line: '8021q'
  when: kvm_host_ConfigOvsBridge


- name: Enable Kernel Modules - VLAN (2/2)
  modprobe:
    name: '8021q'
    state: present
  when: kvm_host_ConfigOvsBridge


- name: Enable IPv4 Forward
  lineinfile:
    dest: /etc/sysctl.conf
    line: 'net.ipv4.ip_forward = 1'
  when: kvm_host_ConfigOvsBridge


- name: Copy Networking Congurations to Remote (1/3 - Bonding)
  template:
    src: templates/ubuntu_bond.cfg.j2
    dest: /etc/network/interfaces.d/{{ kvm_host_LinuxBondName }}.cfg
  notify: restart networking.service
  when: kvm_host_ConfigBondInterface

- name: Copy Networking Congurations to Remote (2/3 - NIC)
  template:
    src: templates/ubuntu_bond_nic.cfg.j2
    dest: /etc/network/interfaces.d/ovs_bond_{{ item }}.cfg
  with_items: '{{ kvm_host_LinuxBondNics }}'
  notify: restart networking.service
  when: kvm_host_ConfigBondInterface
